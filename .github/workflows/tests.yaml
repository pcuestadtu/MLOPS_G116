name: "Run tests"

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest", "windows-latest", "macos-latest"]


    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        fetch-depth: 2

    - name: Authenticate to GCP
      if: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY != '' }}
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - uses: iterative/setup-dvc@v1

    - name: Confirm GCP secret present
      if: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY != '' }}
      run: echo "GCP_SERVICE_ACCOUNT_KEY present, running dvc pull."

    - name: Get data
      if: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY != '' }}
      run: dvc pull

    - name: Skip DVC pull (missing secret)
      if: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY == '' }}
      run: echo "Skipping dvc pull because GCP_SERVICE_ACCOUNT_KEY is not set."

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: 3.12
        cache: "pip"
        cache-dependency-path: |
          requirements.txt
          requirements_dev.txt
          pyproject.toml

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_dev.txt
        pip install -e .
        pip list

    - name: Test with pytest
      run: |
        pytest tests/
